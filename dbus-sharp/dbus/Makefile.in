APIS=dbus-api.xml
MCS=mcs
GAPI_FIXUP=@GAPI_FIXUP@
GAPI_CODEGEN=@GAPI_CODEGEN@
ASSEMBLY=dbus-sharp.dll

all: $(ASSEMBLY)

generated-stamp: $(APIS)
	$(GAPI_CODEGEN) --generate $(APIS) --outdir=generated --customdir=.	\
	--assembly-name=dbus-sharp && touch generated-stamp

$(ASSEMBLY): generated-stamp
	$(MCS) --unsafe -nowarn:0660,0661 /target:library /r:glib-sharp -o $(ASSEMBLY) --recurse '*.cs'

clean:
	rm -f generated-stamp
	rm -f $(ASSEMBLY)
	rm -rf generated

prefix=@prefix@
install=@INSTALL@
DESTDIR=
apidir=$(DESTDIR)$(prefix)/share/gapi
libdir=$(DESTDIR)$(prefix)/lib

install: all
	../mkinstalldirs $(libdir) &&		\
	../mkinstalldirs $(apidir) &&		\
	for i in $(APIS); do                    \
		$(install) -m 664 $$i $(apidir) || true;       \
	done && 				\
	$(install) $(ASSEMBLY) $(libdir)

DISTFILES = Makefile.in $(APIS)

top_distdir = ..
distdir = $(top_distdir)/$(PACKAGE)-$(VERSION)

distdir: $(DISTFILES)
	@list='$(DISTFILES)'; for file in $$list; do \
	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
	  dir=`echo "$$file" | sed -e 's,/[^/]*$$,,'`; \
	  if test "$$dir" != "$$file" && test "$$dir" != "."; then \
	    dir="/$$dir"; \
	    $(mkinstalldirs) "$(distdir)$$dir"; \
	  else \
	    dir=''; \
	  fi; \
	  if test -d $$d/$$file; then \
	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
	    fi; \
	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
	  else \
	    test -f $(distdir)/$$file \
	    || cp -p $$d/$$file $(distdir)/$$file \
	    || exit 1; \
	  fi; \
	done

