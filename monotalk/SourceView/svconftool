#!/usr/bin/perl -w

$PATH = "/apps/monotalk/sourceview";

$schema  = '';
$install = 0;
$apply   = 0;
$config  = '';

while ( my $arg = shift(@ARGV) )
{
	if ( $arg eq '--schema' ) { $schema = shift(@ARGV); next; }
	if ( $arg eq '--install' ) { $install = 1; next; }
	if ( $arg eq '--apply' ) { $apply = 1; next; }
	if ( $arg eq '--help' ) { usage(); exit; }

	$config = $arg;
}


if ( ! $config ) { usage(); exit; }
if ( ! $schema && ! $install && ! $apply ) { usage(); exit; }


$weight = "0";


if ( $schema ) 
{ 
	open(SCHEMA, ">$schema") || die "cannot open $schema\n";

	print SCHEMA << "EOM";
<!-- This file was autogenerated by svconftool. Do not edit by hand. -->

<gconfschemafile>
<schemalist>

EOM
#'

}


open (INPUT, ($config) ? "<$config" : "<&STDIN") || die "cannot open $config\n";

while ( $line = <INPUT> )
{
	$_ = $line;

	if ( /(.+)\\\s*$/ )
	{
		$linebuff .= $1;
		next;
	}

	if ( $linebuff )
	{
		$line = $linebuff . $line;
		$_ = $line;
		$linebuff = '';
	}

	if ( /^\s*style\s*=\s*"(.+)"/ )
	{
		if ( $style )
		{
			&out();
		}

		$style = $1;
		push (@styles, $style);

		next;
	}

	if ( /^\s*keywords\s*=\s*"(.*)"/ )
	{
		$keywords = $1;
		$keywords =~ s/\s+/ /g;
		next;
	}

	if ( /^\s*color\s*=\s*"(.*)"/ )
	{
		$color = $1;
		next;
	}

	if ( /^\s*weight\s*=\s*"(.*)"/ )
	{
		$weight = $1;
		next;
	}

	if ( /^\s*spanto\s*=\s*"(.*)"/ )
	{
		$spanto = $1;
		next;
	}

	if ( /^\s*signore\s*=\s*"(.*)"/ )
	{
		$signore = $1;
		next;
	}

	if ( /^\s*sdelim\s*=\s*"(.*)"/ )
	{
		$sdelim = $1;
		next;
	}

	if ( /^\s*edelim\s*=\s*"(.*)"/ )
	{
		$edelim = $1;
		next;
	}
}

&out(); 


$s = join(' ', @styles);


if ( $schema )
{
	print SCHEMA << "EOM";
<schema>
<key>/schemas$PATH/styles</key>
<applyto>$PATH/styles</applyto>
<owner>SourceView</owner>
<type>string</type>
<default>$s</default>
<locale name="C"></locale>
</schema>

</schemalist>
</gconfschemafile>

EOM
#'

}


if ( $apply ) 
{
	set("styles", $s);
}


if ( $install )
{
	`GCONF_CONFIG_SOURCE="" gconftool-2 --makefile-install-rule $schema`;
}


exit;


#----------------------------------------------------



sub usage 
{
	print 
		"Usage: [options] config_file\n\n",
		"   --schema <file>   where should be the schema file written\n",
		"   --install         install the new schema file using gconftool-2\n",
		"   --apply           set the gconf values (does not need to change schema)\n\n";
}



sub out
{
	if ( $schema ) { &schema_out; }
	if ( $apply )
	{
		set("$style/keywords", $keywords);
		set("$style/color", $color);
		set("$style/weight", $weight);
		set("$style/sdelim", $sdelim);
		set("$style/edelim", $edelim);

		if ( $spanto )
		{
			set("$style/spanto", $spanto);
		}
		else 
		{
			unset("$style/spanto");
		}


		if ( $signore )
		{
			set("$style/signore", $signore);
		}
		else 
		{
			unset("$style/signore");
		}
	}
}



sub set
{
	my $key = shift;
	my $val = shift;

	system("gconftool-2", "-t", "string", "-s", "$PATH/$key", $val);
}


sub unset
{
	my $key = shift;

# this crushes a running objectbrowser, don't know yet why.
#	system("gconftool-2", "-u", "$PATH/$key");
}



sub schema_out
{
	print SCHEMA << "EOM";
<schema>
	<key>/schemas$PATH/$style/keywords</key>
	<applyto>$PATH/$style/keywords</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$keywords</default>
	<locale name="C"></locale>
	</schema>

	<schema>
	<key>/schemas$PATH/$style/color</key>
	<applyto>$PATH/$style/color</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$color</default>
	<locale name="C"></locale>
	</schema>

	<schema>
	<key>/schemas$PATH/$style/weight</key>
	<applyto>$PATH/$style/weight</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$weight</default>
	<locale name="C"></locale>
	</schema>

	<schema>
	<key>/schemas$PATH/$style/sdelim</key>
	<applyto>$PATH/$style/sdelim</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$sdelim</default>
	<locale name="C"></locale>
	</schema>

	<schema>
	<key>/schemas$PATH/$style/edelim</key>
	<applyto>$PATH/$style/edelim</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$edelim</default>
	<locale name="C"></locale>
	</schema>

EOM
#'

	if ( $spanto )
	{

		print SCHEMA << "EOM";
	<schema>
	<key>/schemas$PATH/$style/spanto</key>
	<applyto>$PATH/$style/spanto</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$spanto</default>
	<locale name="C"></locale>
	</schema>
EOM
#'
	}

	if ( $signore )
	{
		print SCHEMA << "EOM";
	<schema>
	<key>/schemas$PATH/$style/signore</key>
	<applyto>$PATH/$style/signore</applyto>
	<owner>SourceView</owner>
	<type>string</type>
	<default>$signore</default>
	<locale name="C"></locale>
	</schema>
EOM
#'
	}
}

