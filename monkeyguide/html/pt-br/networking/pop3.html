<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:monodoc="http://www.go-mono.org/xml/monodoc">
<head>
	<title>A simple POP3 client</title>

	<meta name = "DC.Description" content =" Some practical use of System.Net" />
	<meta name = "DC.Contributor" content =" Johannes Roith" />

	<link rel="stylesheet" type="text/css" href="../style.css" />

	<meta name = "CVS.English.Version" content = "1.5" />
</head>
<body>

<h1>A simple POP3 Client</h1>

<h2>Introduction</h2>
<p>Handbook writing can be very boring, if you have to use only simple, boring useless examples, and I'm sure, reading such stuff might be boring as well ;) . Therefor we will now create a practical example of a TcpClient: A simple Mail Client for POP3 servers.</p>

<p>We will start with a simple console application in this chapter and build a working Mail Client with Gtk# later. The final Gtk# version will handle MIME, attachments and Html Mail.</p>

<p>For now, let's look at the basic communication, that has to be done between client and server.</p>

<h2>The POP3 protocol</h2>

<p>The POP3 standard is a protocol to retreive Mails from a Server to your local computer. It is described in RFC 1939, avavilable <a href="http://www.ietf.org/rfc/rfc1939.txt">here (http://www.ietf.org/rfc/rfc1939.txt)</a>. I can highly recommend to read that document.</p>

<p>Here is a short summary of POP3</p>

After connecting to the server, the server will send a welcome message, that you have to read first. After that, you enter AUTHORIZATION state. The commands valid in this state are:

<pre>
	USER name
	PASS string
	QUIT
</pre>

If you were authorized, you enter tranaciton state. Valid commands are:

<pre>
	STAT
	LIST [msg]
	RETR msg
	DELE msg
	NOOP
	RSET
	QUIT
</pre>

<h2>Server response</h2>

The Server will always respond like that:

<pre>
+OK <i>optional values</i>

<b>or</b>

-ERR <i>optional values</i>
</pre>

<p>So, the first 3/4 bytes indicate, if the command was accepted and everytzing went from, well in fact the first byte is enough (+/-).</p>


<p>I won't tell you how the server behaves exactly on each command, you can find out yourself now. You'll need a pop3 server, where you have a valid account on.</p>

<p>Fire up telnet like: telnet yourserver.org 110</p>

<p>(110 is the pop3 default port).</p>

<p> You can now interactivly test the commands.</p>

<pre>
Trying 195.37.232.164...
Connected to post.tcrz.net.
Escape character is '^]'.

+OK post.tcrz.net POP3 server (Post.Office v3.5.3 release 223 with ZPOP version 1.0 ID# 127-60884U4000L300S0V35) ready Wed, 6 Aug 2003 12:59:32 +0200
</pre>

<p>The welcome message starts with +OK.</p>

Then enter:

<pre>
user <i>username</i>
</pre>

Resonse:
<pre>
+OK Password required for <i>username</i>
</pre>

You enter:

<pre>
pass <i>password</i>
</pre>

and you'll get:

<pre>
+OK Maildrop has 0 messages (0 octets)
</pre>

<p>Or something similiar. +OK means, you have loged in sucessfully and are now in TRANSACTION state.</p>

<p>We will now test the commands.</p>

Enter:
<pre>
stat
</pre>

You will get:

<pre>
+OK 2 300
</pre>

<p>Or similiar. The first number is the number of mails on the server. The second number the size of the mails.
</p>

Now, type:

<pre>
list
</pre>

If there are mails on the server, you'll get:

<pre>
TODO
</pre>

This is however difficult to read and parse and pretty useless. Instead you should use:

<pre>
list <i>mailnumber</i>
</pre>

You know the number of your mails, because of "stat", so you can now type 1 or 2 or 3, if stat has shown, you have 3 mails on the server.

<p>[TODO]</p>
<h2>Code</h2>
Ok, I will just throw in the code for a working client, now. We will walk it through in detail right after that. 


<pre class="code">
// Simple POP3 Class
// (C) 2003 by Johannes Roith

// TODO: MIME support

using System;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.IO;

class MailClient {


	public static void Main(string[] args) {

		MailClient mclient = new MailClient(args[0], 110);
		mclient.Authenticate(args[1], args[2]);

		int number = mclient.GetNumberOfMails();
		Console.WriteLine("You have " + number + " Mails.");

		for (int i = 0; i &lt; number;i++) {

			Console.WriteLine("\n---------------------------------------\n\n");

			Message message = mclient.GetMessage(i);
	
			Console.WriteLine(message.From);
			Console.WriteLine(message.To);
			Console.WriteLine(message.Subject);
			Console.WriteLine(message.Date);
			Console.WriteLine(message.Body);


			Console.WriteLine("\n---------------------------------------\n\n");
		}
	}


	TcpClient client1;

	public MailClient(string host, int port) {

		client1 = new TcpClient();
		client1.Connect(host, port);

		// Read Welcome Message
		NetworkStream stream = client1.GetStream();
		byte[] carray = new byte[256];
		int k = stream.Read(carray, 0, carray.Length);
	
	}
	
	private void Authenticate(string user, string password) {
	
		Send("user " + user + "\r\n");
		Send("pass " + password + "\r\n");
	
	}
	
	public int GetNumberOfMails() {
	
		NetworkStream stream = client1.GetStream();
	
		byte[] data = System.Text.Encoding.ASCII.GetBytes("stat\r\n");
		stream.Write(data, 0, data.Length);
	
	    	string response = "";
	
		byte[] carray = new byte[10000];
	
		// Status
		int k = stream.Read(carray, 0, carray.Length);
	
	    	response = System.Text.Encoding.ASCII.GetString(carray, 0, k);
	
		string[] numpos = response.Split(' ');
		int number = Convert.ToInt32(numpos[1]);
		return number;
		
	}
	
	
	public Message GetMessage(int id) {
	
	
		NetworkStream stream;
		byte[] data;
		int k;
	
		stream = client1.GetStream();
	
	
		data = System.Text.Encoding.ASCII.GetBytes("retr " + id + "\r\n");
		stream.Write(data, 0, data.Length);
	
	    	string response = "";
	
		byte[] carray = new byte[10000];
	
		// Status
		k = stream.Read(carray, 0, carray.Length);
	    	response = System.Text.Encoding.ASCII.GetString(carray, 0, k);
	
	
		string[] numpos = response.Split(' ');
		int octets = Convert.ToInt32(numpos[1]);
	
	
		carray = new byte[octets];
	
		// Actually Read the Content
		k = stream.Read(carray, 0, carray.Length);
	    	response = System.Text.Encoding.ASCII.GetString(carray, 0, k);
	
		int index = response.IndexOf("\r\n\r\n");
	
		string head = response.Substring(0, index);
		string body = response.Substring(index, response.Length - index);
	
		string[] headerlines = head.Split('\n');
	
		Message message = new Message();
	
		message.Head = head;
		message.Body = body;
	
		foreach (string line in headerlines) {
	
			index = line.IndexOf(":");
	
			if (index == -1)
				continue;
			string item = line.Substring(0, index);
	
			switch (item) {
	
				case "From":
					message.From = line.Substring(index + 1,line.Length - (index + 1)).Trim();
				break;
	
				case "To":
					message.To = line.Substring(index + 1,line.Length - (index + 1)).Trim();
				break;
	
				case "Subject":
					message.Subject = line.Substring(index + 1,line.Length - (index + 1)).Trim();
				break;
	
				case "Date":
					message.Date = line.Substring(index + 1,line.Length - (index + 1)).Trim();
				break;
	
			}
		}
	
		return message;
		
	}
	
	private string Send(string str) {
	
		NetworkStream stream = client1.GetStream();
	
	
		byte[] data = System.Text.Encoding.ASCII.GetBytes(str);
		stream.Write(data, 0, data.Length);
	
	    	string response = "";
	
		byte[] carray = new byte[1024];
	
		int k = stream.Read(carray, 0, carray.Length);
	    	response = System.Text.Encoding.ASCII.GetString(carray, 0, k);
	
		return response;
	}

}
	
class Message {
	
	public string From    = "";
	public string To      = "";
	public string Subject = "";
	public string Date    = "";
	
	public string Head    = "";
	public string Body    = "";
	
}

</pre>

<p>Before we take a closer look at the code, run the example.</p>

<pre>
mono pop3.exe <i>server user password</i>
</pre>

<h2>Code walktrough</h2>

[TODO]

</body>
</html>
