<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:monodoc="http://www.go-mono.org/xml/monodoc">
<head>
	<title>Using Java with Mono</title>

	<meta name ="DC.Description" content ="" />
	<meta name ="DC.Contributor" content ="Miguel de Icaza" />
	<link rel="stylesheet" type="text/css" href="../style.css" />
</head>

<body>

<h2>Using Java with Mono</h2>

	<p>This is taken from the <a
	href="http://primates.ximian.com/~miguel//texts/gtkjava.html">Blog
	entry</a> on using Java with Gtk#.</p>
	
	<p>Mono is able to run Java code side-by-side with .NET as
	well as having Java and .NET object interoperate with each
	other.  This is done with <a
	href="http://www.ikvm.net">IKVM</a> the Java VM implementation
	that runs on top of .NET and Mono.</p>

	<p>There are two possible ways of using IKVM: one is to use it
	as a Just-in-Time compiler which translates the Java bytecodes
	into .NET Intermediate Language as it goes.  But this means
	that at runtime you are compiling things twice: the
	Java-to-CIL JIT and the CIL-to-Native JIT.</p>

	<p>We are going to build some samples using Gtk#</p>
	
	<p>Gtk# is really a bad name.  Because Gtk# is not limited to
	C#, any programming language in the .NET framework can use it
	today and because it covers more than only the Gtk API, it
	covers various other components of the GNOME Development
	Platform. </p>

<h3>Getting Started</h3>

	<p>If you have a complete Mono installation you will already
	have all the elements necessary: Mono, IKVM and Gtk#.</p>

<h3>Exposing .NET Libraries to Java</h3>

	<p>Now, Gtk# is a .NET assembly (this is the ECMA lingo for
	"library"), and Java does not know anything about this.  It is
	necessary first to generate some stubs for these classes to
	let the Java compiler knows about the types defined in the C#
	world.  This is done using the <tt>netexp.exe</tt> program
	from IKVM, like this:</p>

<pre class="console">

    $ ikvmstub /mono/lib/mscorlib.dll
    $ ikvmstub /mono/lib/mono/gtk-sharp/gtk-sharp.dll
    $ ikvmstub /mono/lib/mono/gtk-sharp/glib-sharp.dll
    $ ikvmstub /mono/lib/mono/gtk-sharp/atk-sharp.dll

</pre>	

	<p>The above commands basically "imports" all of the types and
	their definitions into something suitable for Java to consume,
	the result is:</p>
	
<pre class="console">

    $ ls *.jar
    atk-sharp.jar  glib-sharp.jar  gtk-sharp.jar  mscorlib.jar

</pre>	

	<p>The <tt>ikvmstub</tt> program will import all of the
	types into the "cli" namespace.  So if you had a class called
	"Gtk.Window", it will be exposed to Java as "cli.Gtk.Window". </p>

<h3>Compiling our program</h3>

	<p>This is a very basic Java program that initializes Gtk#:</p>

<pre class="code">
import cli.Gtk.*;
public class Demo {
	public static void main(String[] args) {
		Application.Init ();
		Application.Run ();
	}
}
</pre>

	<p>To compile the above program type:</p>

<pre class="console">

    $ javac -classpath gtk-sharp.jar Demo.java

</pre>

	<p>This produces a <tt>Demo.class</tt> file that contains the
	Java bytecodes.  The -classpath file instructs the Java
	compiler to find the type definitions on the
	<tt>gtk-sharp.jar</tt> file that we had previously produced
	with <tt>ikvmstub</tt>.</p>

<h3>Running our Java code in Mono</h3>

	<p>Now, it is not possible to run this directly
	in Java, since the jar files produced by netexp.exe are only
	stubs, so we will need to run this in the Mono world using
	IKVM in JIT mode:</p>

<pre class="console">

    $ ikvm -classpath .:gtk-sharp.jar Demo

</pre>

	<p>The above just sits there waiting for events, so feel free
	to kill that.  We will now add some meat to the program, this
	is a slightly more interesting sample:</p>

<pre class="code">

import cli.Gtk.*;
import cli.GLib.*;

public class Demo {
	public static void main(String[] args) {
		Application.Init ();
		Window w = new Window ("Hello Mono with Java#");
		Button b = new Button ("Click me");
		w.Add (b);
		w.ShowAll ();
		Application.Run ();
	}
}
</pre>

	<p>To compile, you will need to reference the libraries we
	created before:</p>

<pre class="console">

    $ javac -classpath 'gtk-sharp.jar:glib-sharp.jar:atk-sharp.jar:
    mscorlib.jar:.' Demo.java

</pre>

	<p>This will produce <tt>Demo.class</tt>, now run it:</p>
	
<pre class="console">

    $ ikvm -classpath .:gtk-sharp.jar Demo

</pre>

	<p>The result is shown here:</p>

	<p><center><img src="Java.png"/></center></p>


	<p>The above is basically translating Demo.class from JVM
	bytecodes to ECMA CIL, then the Mono JIT translates that into
	native x86 code.  The next step is to precompile the Java code
	directly into .NET code, which will skip the double JIT
	process:</p>

<pre class="console">

    $ ikvmc -reference:`pwd`/classpath.dll Demo.class gtk-sharp.jar
    $ ls *exe
    Demo.exe
    $

</pre>

	<p>The above compiled the code directly into a a Mono/.NET
	executable, to run it, just do:</p>

<pre class="shell">

    $ mono Demo.exe

</pre>

<h3>Compiling Java code to x86 code</h3>

	<p>But we can go one step further.  We can avoid completely
	the JIT process by precompiling the .exe file which contains
	instructions in the ECMA Common Intermediate Language into
	native x86 code using Mono's Ahead-of-Time compiler, to do
	this, type:</p>

<pre class="console">

    $ mono --aot Demo.exe
    $ ls Demo.*
    Demo.class  Demo.dll  Demo.exe  Demo.exe.so

</pre>

	<p>The <tt>Demo.exe.so</tt> contains the native x86 code.
	Mono still requires the Demo.exe file to be around to extract
	metadata, but the Just-in-Time compiler will not be used in
	that case:</p>

<pre class="console">

    $ mono Demo.exe

</pre>

	<p>Mono detects the shared object file and resolves methods to
	those contained in the image file.  You can see the native
	code generated by using the objdump command:</p>

<pre class="console">

    $ objdump -d Demo.exe.so
    ...
    
</pre>

	
<h3>How complete is Mono/IKVM?</h3>

	<p>Mono and IKVM depend on the GNU Classpath, so it is as
	complete as open source Java, but you get the added advantage
	of accessing any Mono/.NET libraries as well.</p>

	<p>Today Mono/IKVM can run large applications like Eclipse,
	Jython and JBoss.  Screenshot of <a
	href="http://primates.ximian.com/~miguel/images/eclipse-mono.png">Eclipse
	running on Mono</a>.</p>

</body>
</html>
